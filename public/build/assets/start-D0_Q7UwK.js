import{u as O,R as o,j as t,L as B}from"./app-klcUL3EL.js";import{B as P}from"./badge-KCBe1nWM.js";import{B as N}from"./button-Bh8WI1Ty.js";import{S as J}from"./student-layouts-DOMVx04C.js";import{y as U}from"./type-BKOnXlFr.js";import"./app-Ci7uHgFL.js";import"./index-A7wesXx6.js";import"./index-Ds5qzORP.js";import"./index-CyaJm5Nq.js";import"./utils-e8IeQt0G.js";import"./page-banner-DONW1mv1.js";import"./index-BqTge0le.js";import"./index-CMWG4mbA.js";import"./index-BQcbsxov.js";import"./iconBase-BVw07lCS.js";import"./arrow-left-DMV9iy1g.js";import"./createLucideIcon-DknjQr1d.js";import"./app-logo-icon-ijSwabQD.js";import"./divider-Dzwd8ovy.js";import"./profile-svg-BWG5dZ33.js";import"./user-profile-trigger-BnF5rMVz.js";import"./sun-UD3V7mlH.js";import"./avatar-BdB_hIma.js";import"./index-C7Q-OePl.js";import"./index-DATr0Fl4.js";import"./index-DkAn70oM.js";import"./avatar-fallback-BDH5mD5T.js";import"./use-initials-GDEZD6-s.js";import"./dropdown-menu-Buaj86n5.js";import"./index-hw-50Y8m.js";import"./index-D7xMndjq.js";import"./index-BrvB-LOg.js";import"./index-C9hgHX-E.js";import"./index-CPeTD8AP.js";import"./index-qHu87rw-.js";import"./check-9HY1vcbG.js";import"./logout-user-CTkV5_42.js";import"./spinner-2t8r_D1R.js";import"./index-wHDUIrgA.js";import"./index-v3lNCs8j.js";import"./index-DGvaH1zc.js";import"./log-out-uPqsp4v0.js";import"./index-ClAXPadg.js";import"./index-DMEIf3eg.js";import"./index-B5Wz6g3U.js";import"./index-B_X-8rh8.js";import"./nav-items-uSlAyQCt.js";import"./settings-C4I39P2J.js";import"./gauge-BODaeFnF.js";import"./book-P6H3vioY.js";import"./calendar-CUp6x8Fo.js";import"./book-open-qbgfrGvc.js";import"./x-DGooslga.js";import"./menu-CTQlVSPW.js";const V=l=>{const c=Math.floor(l/60).toString().padStart(2,"0"),r=(l%60).toString().padStart(2,"0");return`${c}:${r}`},S=l=>`quiz_progress_${l}`;function Fe(){const{quiz:l,questions:c}=O().props,r=l,f=c&&c.length?c:[],[n,h]=o.useState(0),[m,z]=o.useState({}),[d,q]=o.useState(0),[E,_]=o.useState(!1),[Q,$]=o.useState(null),[C,g]=o.useState(null),y=f.length,v=o.useRef(null);o.useEffect(()=>{try{const e=localStorage.getItem(S(r.slug??r.id));if(e){const s=JSON.parse(e);typeof s.currentIndex=="number"&&h(s.currentIndex),s.answers&&z(s.answers),typeof s.timeElapsed=="number"&&q(s.timeElapsed)}}catch(e){console.error("Error parsing stored quiz state",e)}},[r.slug,r.id]),o.useEffect(()=>{v.current=window.setInterval(()=>{q(s=>s+1)},1e3);const e=()=>{b()};return window.addEventListener("beforeunload",e),()=>{v.current&&window.clearInterval(v.current),window.removeEventListener("beforeunload",e),b()}},[]),o.useEffect(()=>{b()},[m,n,d]);function b(){try{const e={currentIndex:n,answers:m,timeElapsed:d};localStorage.setItem(S(r.slug??r.id),JSON.stringify(e))}catch(e){console.error("Could not save quiz state",e)}}function k(){try{localStorage.removeItem(S(r.slug??r.id))}catch(e){console.error("Could not clear quiz state",e)}}function R(e,s,i){z(u=>{const p={...u},w=e.id;if(i){const x=p[w]??[],L=x.indexOf(s);L>=0?x.splice(L,1):x.push(s),p[w]=x}else p[w]=s;return p})}function T(){n<y-1&&h(e=>e+1)}function A(){n>0&&h(e=>e-1)}function I(e){const s=m[e.id];return e.is_mandatory?Array.isArray(s)?s.length>0:!!s:!0}async function M(){const e=f.filter(i=>i.is_mandatory&&!I(i));if(e.length){g(`Veuillez répondre à toutes les questions obligatoires (${e.length}).`),window.scrollTo({top:0,behavior:"smooth"});return}_(!0),g(null);const s={quiz_id:r.id,answers:Object.entries(m).map(([i,u])=>({question_id:Number(i),answer:u})),time_elapsed_seconds:d};try{const i=await fetch(`/api/quizzes/${r.id}/submit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!i.ok)throw new Error(`Server responded ${i.status}`);const u=await i.json();k(),$("Quiz envoyé avec succès. Merci !")}catch(i){console.error("Submission error",i),g("Une erreur est survenue lors de l’envoi. Réessayez plus tard.")}finally{_(!1)}}const a=f[n],j=m[a?.id??-1];return t.jsx(J,{title:`Quiz : ${r.title??"Quiz"}`,children:t.jsxs("div",{className:"mx-auto mt-6 max-w-3xl",children:[t.jsxs("div",{className:"mb-4 flex flex-col items-center justify-between sm:flex-row",children:[t.jsxs("div",{children:[t.jsx("h1",{className:"text-xl font-bold text-gray-900",children:r.title??"Quiz"}),t.jsxs("p",{className:"mt-1 text-sm text-gray-500",children:["Progression:"," ",t.jsxs("span",{className:"font-medium",children:["Question ",n+1," / ",y]})]})]}),t.jsxs("div",{className:"mt-3 flex w-full flex-row justify-between gap-4 text-sm text-gray-600 sm:flex-col",children:[t.jsx("div",{className:"mb-1 text-right",children:"Temps écoulé"}),t.jsx("div",{className:"rounded-md bg-gray-100 px-3 py-1 font-mono text-sm",children:V(d)})]})]}),t.jsx(P,{className:"mb-4",variant:"outline",children:U(a.question_type)}),C&&t.jsx("div",{className:"mb-4 rounded-md border border-red-200 bg-red-50 p-3 text-sm text-red-700",children:C}),Q&&t.jsx("div",{className:"mb-4 rounded-md border border-green-200 bg-green-50 p-3 text-sm text-green-700",children:Q}),t.jsxs("div",{className:"rounded-lg border bg-white p-6 shadow-sm",children:[t.jsx("div",{className:"flex items-start justify-between",children:t.jsxs("div",{className:"flex-1",children:[t.jsxs("div",{className:"text-sm text-gray-500",children:["Question ",n+1," •"," ",a.points," pts"]}),t.jsx("h2",{className:"mt-2 text-lg font-semibold text-gray-800",children:a.question_text}),t.jsx("div",{className:"mt-4 space-y-3",children:(a.answers??[]).map(e=>{const s=a.question_type==="multiple_choice",i=s?Array.isArray(j)&&j.includes(e.id):j===e.id;return t.jsxs("label",{className:"flex cursor-pointer items-center gap-3 rounded-md border p-3 transition hover:bg-gray-50",children:[t.jsx("input",{type:s?"checkbox":"radio",name:`q_${a.id}`,checked:i,onChange:()=>R(a,e.id,s),className:"h-4 w-4"}),t.jsx("div",{className:"text-sm text-gray-700",children:e.answer_text})]},e.id)})})]})}),t.jsxs("div",{className:"mt-6 flex items-center justify-between",children:[t.jsx("div",{children:t.jsx(N,{variant:"outline",onClick:A,disabled:n===0,children:"Précédent"})}),t.jsx("div",{className:"flex items-center gap-3",children:n<y-1?t.jsx(N,{onClick:T,disabled:!I(a),children:"Suivant"}):t.jsx(N,{onClick:M,className:"bg-green-600 text-white hover:bg-green-700",disabled:E,children:E?"Envoi...":"Envoyer"})})]})]}),t.jsx("div",{className:"mt-4 text-center text-xs text-gray-400",children:"Vos réponses sont automatiquement sauvegardées localement."}),t.jsx("div",{className:"mt-6 text-center",children:t.jsx(B,{href:"/student/quizzes",className:"text-sm text-gray-500 hover:underline",children:"Retour à la liste des quizzes"})})]})})}export{Fe as default};
