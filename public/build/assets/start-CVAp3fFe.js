import{u as O,R as o,j as t,L as B}from"./app-DeYJtq_f.js";import{B as P}from"./badge-B58VR4ZU.js";import{B as N}from"./button-BcaJHoph.js";import{S as J}from"./student-layouts-DRQuGvV9.js";import{y as U}from"./type-DDACwUq3.js";import"./app-BCy0fQWz.js";import"./index-CEnOPdIs.js";import"./index-B11fw4J1.js";import"./index-CyaJm5Nq.js";import"./utils-e8IeQt0G.js";import"./page-banner-C1yrir3H.js";import"./index-BqTge0le.js";import"./index-CMWG4mbA.js";import"./index-k2eac2c_.js";import"./iconBase-C8Bl2Plt.js";import"./arrow-left-Irc5x4Dh.js";import"./createLucideIcon-CfblyJan.js";import"./app-logo-icon-CWsD0s5t.js";import"./divider-5bYZGO3M.js";import"./profile-svg-iVkyBrBD.js";import"./user-profile-trigger-Xak7ovX_.js";import"./sun-snLyNwyX.js";import"./avatar-5JSxo7RZ.js";import"./index-CPAp0ZwD.js";import"./index-CRYvoW22.js";import"./index-Vxp116jM.js";import"./avatar-fallback-B4U7h7tJ.js";import"./use-initials-GDEZD6-s.js";import"./dropdown-menu-IxUt_7SR.js";import"./index-BwNBMMTM.js";import"./index-BCH18vAN.js";import"./index-CGIMGQ61.js";import"./index-BQl0Ih9O.js";import"./index-CRl0w9kv.js";import"./index-Wx2anTsr.js";import"./check-BmdHRGGA.js";import"./logout-user-Ei4iZAgh.js";import"./spinner-B5HXeZy2.js";import"./index-wHDUIrgA.js";import"./index-v3lNCs8j.js";import"./index-DGvaH1zc.js";import"./log-out-Cg8HsoaD.js";import"./index-CsOHd55-.js";import"./index-DMEIf3eg.js";import"./index-B5Wz6g3U.js";import"./index-088ta_6r.js";import"./nav-items-WsK0wusG.js";import"./settings-CGmjSwyj.js";import"./gauge-CABQgVsA.js";import"./book-BCEQ4q0d.js";import"./calendar-JDaLO9Dd.js";import"./book-open-HnbYJyRm.js";import"./x-gqbQ14sC.js";import"./menu-G3x5lOUn.js";const V=l=>{const c=Math.floor(l/60).toString().padStart(2,"0"),r=(l%60).toString().padStart(2,"0");return`${c}:${r}`},S=l=>`quiz_progress_${l}`;function Fe(){const{quiz:l,questions:c}=O().props,r=l,f=c&&c.length?c:[],[n,h]=o.useState(0),[m,z]=o.useState({}),[d,q]=o.useState(0),[E,_]=o.useState(!1),[Q,$]=o.useState(null),[C,g]=o.useState(null),y=f.length,v=o.useRef(null);o.useEffect(()=>{try{const e=localStorage.getItem(S(r.slug??r.id));if(e){const s=JSON.parse(e);typeof s.currentIndex=="number"&&h(s.currentIndex),s.answers&&z(s.answers),typeof s.timeElapsed=="number"&&q(s.timeElapsed)}}catch(e){console.error("Error parsing stored quiz state",e)}},[r.slug,r.id]),o.useEffect(()=>{v.current=window.setInterval(()=>{q(s=>s+1)},1e3);const e=()=>{b()};return window.addEventListener("beforeunload",e),()=>{v.current&&window.clearInterval(v.current),window.removeEventListener("beforeunload",e),b()}},[]),o.useEffect(()=>{b()},[m,n,d]);function b(){try{const e={currentIndex:n,answers:m,timeElapsed:d};localStorage.setItem(S(r.slug??r.id),JSON.stringify(e))}catch(e){console.error("Could not save quiz state",e)}}function k(){try{localStorage.removeItem(S(r.slug??r.id))}catch(e){console.error("Could not clear quiz state",e)}}function R(e,s,i){z(u=>{const p={...u},w=e.id;if(i){const x=p[w]??[],L=x.indexOf(s);L>=0?x.splice(L,1):x.push(s),p[w]=x}else p[w]=s;return p})}function T(){n<y-1&&h(e=>e+1)}function A(){n>0&&h(e=>e-1)}function I(e){const s=m[e.id];return e.is_mandatory?Array.isArray(s)?s.length>0:!!s:!0}async function M(){const e=f.filter(i=>i.is_mandatory&&!I(i));if(e.length){g(`Veuillez répondre à toutes les questions obligatoires (${e.length}).`),window.scrollTo({top:0,behavior:"smooth"});return}_(!0),g(null);const s={quiz_id:r.id,answers:Object.entries(m).map(([i,u])=>({question_id:Number(i),answer:u})),time_elapsed_seconds:d};try{const i=await fetch(`/api/quizzes/${r.id}/submit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!i.ok)throw new Error(`Server responded ${i.status}`);const u=await i.json();k(),$("Quiz envoyé avec succès. Merci !")}catch(i){console.error("Submission error",i),g("Une erreur est survenue lors de l’envoi. Réessayez plus tard.")}finally{_(!1)}}const a=f[n],j=m[a?.id??-1];return t.jsx(J,{title:`Quiz : ${r.title??"Quiz"}`,children:t.jsxs("div",{className:"mx-auto mt-6 max-w-3xl",children:[t.jsxs("div",{className:"mb-4 flex flex-col items-center justify-between sm:flex-row",children:[t.jsxs("div",{children:[t.jsx("h1",{className:"text-xl font-bold text-gray-900",children:r.title??"Quiz"}),t.jsxs("p",{className:"mt-1 text-sm text-gray-500",children:["Progression:"," ",t.jsxs("span",{className:"font-medium",children:["Question ",n+1," / ",y]})]})]}),t.jsxs("div",{className:"mt-3 flex w-full flex-row justify-between gap-4 text-sm text-gray-600 sm:flex-col",children:[t.jsx("div",{className:"mb-1 text-right",children:"Temps écoulé"}),t.jsx("div",{className:"rounded-md bg-gray-100 px-3 py-1 font-mono text-sm",children:V(d)})]})]}),t.jsx(P,{className:"mb-4",variant:"outline",children:U(a.question_type)}),C&&t.jsx("div",{className:"mb-4 rounded-md border border-red-200 bg-red-50 p-3 text-sm text-red-700",children:C}),Q&&t.jsx("div",{className:"mb-4 rounded-md border border-green-200 bg-green-50 p-3 text-sm text-green-700",children:Q}),t.jsxs("div",{className:"rounded-lg border bg-white p-6 shadow-sm",children:[t.jsx("div",{className:"flex items-start justify-between",children:t.jsxs("div",{className:"flex-1",children:[t.jsxs("div",{className:"text-sm text-gray-500",children:["Question ",n+1," •"," ",a.points," pts"]}),t.jsx("h2",{className:"mt-2 text-lg font-semibold text-gray-800",children:a.question_text}),t.jsx("div",{className:"mt-4 space-y-3",children:(a.answers??[]).map(e=>{const s=a.question_type==="multiple_choice",i=s?Array.isArray(j)&&j.includes(e.id):j===e.id;return t.jsxs("label",{className:"flex cursor-pointer items-center gap-3 rounded-md border p-3 transition hover:bg-gray-50",children:[t.jsx("input",{type:s?"checkbox":"radio",name:`q_${a.id}`,checked:i,onChange:()=>R(a,e.id,s),className:"h-4 w-4"}),t.jsx("div",{className:"text-sm text-gray-700",children:e.answer_text})]},e.id)})})]})}),t.jsxs("div",{className:"mt-6 flex items-center justify-between",children:[t.jsx("div",{children:t.jsx(N,{variant:"outline",onClick:A,disabled:n===0,children:"Précédent"})}),t.jsx("div",{className:"flex items-center gap-3",children:n<y-1?t.jsx(N,{onClick:T,disabled:!I(a),children:"Suivant"}):t.jsx(N,{onClick:M,className:"bg-green-600 text-white hover:bg-green-700",disabled:E,children:E?"Envoi...":"Envoyer"})})]})]}),t.jsx("div",{className:"mt-4 text-center text-xs text-gray-400",children:"Vos réponses sont automatiquement sauvegardées localement."}),t.jsx("div",{className:"mt-6 text-center",children:t.jsx(B,{href:"/student/quizzes",className:"text-sm text-gray-500 hover:underline",children:"Retour à la liste des quizzes"})})]})})}export{Fe as default};
