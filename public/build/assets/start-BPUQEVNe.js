import{u as O,R as o,j as t,L as B}from"./app-CjIWy3eH.js";import{B as P}from"./badge-BFvWF1om.js";import{B as N}from"./button-CExzQmZc.js";import{S as J}from"./student-layouts-pAsDbnCY.js";import{y as U}from"./type-DDACwUq3.js";import"./app-DfLmVDUM.js";import"./index-C4soMqjN.js";import"./index-BnYBuebb.js";import"./utils-AnTb9DBe.js";import"./tasks-gWUZeaAY.js";import"./index-BqTge0le.js";import"./index-CMWG4mbA.js";import"./lexical-headless-BCA5NgA9.js";import"./nodes-B8QjlgCe.js";import"./page-banner-IgGXIOfs.js";import"./index-CHnKU68i.js";import"./iconBase-ZLoFHiO_.js";import"./arrow-left-DAnQtW-a.js";import"./createLucideIcon-i13MEz2U.js";import"./app-logo-icon-hvVxL52x.js";import"./divider-D-eLoZ7M.js";import"./profile-svg-Cv26bH6a.js";import"./user-profile-trigger-CmjyThd_.js";import"./avatar-8Q0-AYNg.js";import"./index-OYVf1Zwz.js";import"./index-DnZUlvAx.js";import"./index-Cx1mEBwh.js";import"./avatar-fallback-DKyWtIhb.js";import"./use-initials-GDEZD6-s.js";import"./dropdown-menu-DUsmAPKS.js";import"./index-aXAQScOB.js";import"./index-CgNbq55-.js";import"./index-CPWTBhsT.js";import"./index-DdCDBdhx.js";import"./index-DIo9abDA.js";import"./index-DLvqQGle.js";import"./check-C6ufmhQW.js";import"./logout-user-BBug3-28.js";import"./spinner-Bb2x751J.js";import"./index-wHDUIrgA.js";import"./index-v3lNCs8j.js";import"./index-DGvaH1zc.js";import"./log-out-Bz_ayeBV.js";import"./index-5dwg6Nh6.js";import"./index-DMEIf3eg.js";import"./index-BCspIYgb.js";import"./index-V0aQkvK_.js";import"./index-DXT9ONqy.js";import"./index-lBAoiumE.js";import"./index-Di1vi8wQ.js";import"./gauge-au9SJ6qx.js";import"./book-D1z74oI7.js";import"./calendar-Bfdj--jJ.js";import"./message-circle-CqdwJGEq.js";import"./settings-P3TSVHSR.js";import"./x-CvJE1FTX.js";import"./menu-F5M2EXT6.js";const V=c=>{const l=Math.floor(c/60).toString().padStart(2,"0"),r=(c%60).toString().padStart(2,"0");return`${l}:${r}`},S=c=>`quiz_progress_${c}`;function Ge(){const{quiz:c,questions:l}=O().props,r=c,f=l&&l.length?l:[],[n,h]=o.useState(0),[m,z]=o.useState({}),[d,q]=o.useState(0),[E,_]=o.useState(!1),[Q,$]=o.useState(null),[C,g]=o.useState(null),y=f.length,v=o.useRef(null);o.useEffect(()=>{try{const e=localStorage.getItem(S(r.slug??r.id));if(e){const s=JSON.parse(e);typeof s.currentIndex=="number"&&h(s.currentIndex),s.answers&&z(s.answers),typeof s.timeElapsed=="number"&&q(s.timeElapsed)}}catch(e){console.error("Error parsing stored quiz state",e)}},[r.slug,r.id]),o.useEffect(()=>{v.current=window.setInterval(()=>{q(s=>s+1)},1e3);const e=()=>{b()};return window.addEventListener("beforeunload",e),()=>{v.current&&window.clearInterval(v.current),window.removeEventListener("beforeunload",e),b()}},[]),o.useEffect(()=>{b()},[m,n,d]);function b(){try{const e={currentIndex:n,answers:m,timeElapsed:d};localStorage.setItem(S(r.slug??r.id),JSON.stringify(e))}catch(e){console.error("Could not save quiz state",e)}}function k(){try{localStorage.removeItem(S(r.slug??r.id))}catch(e){console.error("Could not clear quiz state",e)}}function R(e,s,i){z(u=>{const p={...u},w=e.id;if(i){const x=p[w]??[],L=x.indexOf(s);L>=0?x.splice(L,1):x.push(s),p[w]=x}else p[w]=s;return p})}function T(){n<y-1&&h(e=>e+1)}function A(){n>0&&h(e=>e-1)}function I(e){const s=m[e.id];return e.is_mandatory?Array.isArray(s)?s.length>0:!!s:!0}async function M(){const e=f.filter(i=>i.is_mandatory&&!I(i));if(e.length){g(`Veuillez répondre à toutes les questions obligatoires (${e.length}).`),window.scrollTo({top:0,behavior:"smooth"});return}_(!0),g(null);const s={quiz_id:r.id,answers:Object.entries(m).map(([i,u])=>({question_id:Number(i),answer:u})),time_elapsed_seconds:d};try{const i=await fetch(`/api/quizzes/${r.id}/submit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!i.ok)throw new Error(`Server responded ${i.status}`);const u=await i.json();k(),$("Quiz envoyé avec succès. Merci !")}catch(i){console.error("Submission error",i),g("Une erreur est survenue lors de l’envoi. Réessayez plus tard.")}finally{_(!1)}}const a=f[n],j=m[a?.id??-1];return t.jsx(J,{title:`Quiz : ${r.title??"Quiz"}`,children:t.jsxs("div",{className:"mx-auto mt-6 max-w-3xl px-4",children:[t.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("h1",{className:"text-xl font-bold text-gray-900",children:r.title??"Quiz"}),t.jsxs("p",{className:"mt-1 text-sm text-gray-500",children:["Progression:"," ",t.jsxs("span",{className:"font-medium",children:["Question ",n+1," / ",y]})]})]}),t.jsxs("div",{className:"text-sm text-gray-600",children:[t.jsx("div",{className:"mb-1 text-right",children:"Temps écoulé"}),t.jsx("div",{className:"rounded-md bg-gray-100 px-3 py-1 font-mono text-sm",children:V(d)})]})]}),t.jsx(P,{className:"mb-4",variant:"outline",children:U(a.question_type)}),C&&t.jsx("div",{className:"mb-4 rounded-md border border-red-200 bg-red-50 p-3 text-sm text-red-700",children:C}),Q&&t.jsx("div",{className:"mb-4 rounded-md border border-green-200 bg-green-50 p-3 text-sm text-green-700",children:Q}),t.jsxs("div",{className:"rounded-lg border bg-white p-6 shadow-sm",children:[t.jsx("div",{className:"flex items-start justify-between",children:t.jsxs("div",{className:"flex-1",children:[t.jsxs("div",{className:"text-sm text-gray-500",children:["Question ",n+1," •"," ",a.points," pts"]}),t.jsx("h2",{className:"mt-2 text-lg font-semibold text-gray-800",children:a.question_text}),t.jsx("div",{className:"mt-4 space-y-3",children:(a.answers??[]).map(e=>{const s=a.question_type==="multiple_choice",i=s?Array.isArray(j)&&j.includes(e.id):j===e.id;return t.jsxs("label",{className:"flex cursor-pointer items-center gap-3 rounded-md border p-3 transition hover:bg-gray-50",children:[t.jsx("input",{type:s?"checkbox":"radio",name:`q_${a.id}`,checked:i,onChange:()=>R(a,e.id,s),className:"h-4 w-4"}),t.jsx("div",{className:"text-sm text-gray-700",children:e.answer_text})]},e.id)})})]})}),t.jsxs("div",{className:"mt-6 flex items-center justify-between",children:[t.jsx("div",{children:t.jsx(N,{variant:"outline",onClick:A,disabled:n===0,children:"Précédent"})}),t.jsx("div",{className:"flex items-center gap-3",children:n<y-1?t.jsx(N,{onClick:T,disabled:!I(a),children:"Suivant"}):t.jsx(N,{onClick:M,className:"bg-green-600 text-white hover:bg-green-700",disabled:E,children:E?"Envoi...":"Envoyer"})})]})]}),t.jsx("div",{className:"mt-4 text-center text-xs text-gray-400",children:"Vos réponses sont automatiquement sauvegardées localement."}),t.jsx("div",{className:"mt-6 text-center",children:t.jsx(B,{href:"/student/quizzes",className:"text-sm text-gray-500 hover:underline",children:"Retour à la liste des quizzes"})})]})})}export{Ge as default};
