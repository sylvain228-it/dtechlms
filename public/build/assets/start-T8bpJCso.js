import{u as O,R as o,j as t,L as B}from"./app-BzXwBPBx.js";import{B as P}from"./badge-fo3-CsRB.js";import{B as N}from"./button-DpCkL2lj.js";import{T as J}from"./student-layouts-t6pggq_i.js";import{A as U}from"./type-DhUEUhhk.js";import"./app-BlAWqAGg.js";import"./index-D1DaFm8C.js";import"./index-CmvPZPYG.js";import"./index-CyaJm5Nq.js";import"./utils-e8IeQt0G.js";import"./page-banner-CF78MDYO.js";import"./index-BqTge0le.js";import"./index-CMWG4mbA.js";import"./index-DF2umSuw.js";import"./iconBase-BH9TG5R0.js";import"./arrow-left-AHTPeAno.js";import"./createLucideIcon-BboBuA9R.js";import"./app-logo-icon-C2LaG9_Q.js";import"./divider-B09NDvil.js";import"./profile-svg-DwoHoZ6q.js";import"./user-profile-trigger-Dk_TTr5J.js";import"./sun-D7S3RfEj.js";import"./avatar-BR3sBMG9.js";import"./index-BWbkfBfC.js";import"./index-BZwf-zK1.js";import"./index-B2cDW95s.js";import"./avatar-fallback-D5NPW7a4.js";import"./use-initials-GDEZD6-s.js";import"./dropdown-menu-DlZS67It.js";import"./index-VdYImSg5.js";import"./index-CJlYDfk2.js";import"./index-DAHL75PX.js";import"./index-BQPF0Rq9.js";import"./index-BucdvD4Q.js";import"./index-BRTuzqyl.js";import"./check-BHZKRPmL.js";import"./logout-user-Ce_sIJue.js";import"./spinner-CIZwnsdn.js";import"./index-wHDUIrgA.js";import"./index-v3lNCs8j.js";import"./index-DGvaH1zc.js";import"./log-out-BkvcRscv.js";import"./index-Vl0f8Y-f.js";import"./index-DMEIf3eg.js";import"./index-BemDBUNW.js";import"./index-CQybyuYf.js";import"./index-B_X-8rh8.js";import"./nav-items-Ccw_83S7.js";import"./index-BGGtLgwn.js";import"./settings-NUZ-cO65.js";import"./gauge-Cjf8cet3.js";import"./book-Br9QRIqO.js";import"./calendar-BjFjFj4e.js";import"./book-open-DAOtQgtK.js";import"./x-BWOBLZ9u.js";import"./menu-CWhsNS-k.js";const V=l=>{const c=Math.floor(l/60).toString().padStart(2,"0"),r=(l%60).toString().padStart(2,"0");return`${c}:${r}`},S=l=>`quiz_progress_${l}`;function De(){const{quiz:l,questions:c}=O().props,r=l,f=c&&c.length?c:[],[n,h]=o.useState(0),[m,z]=o.useState({}),[d,q]=o.useState(0),[E,_]=o.useState(!1),[Q,L]=o.useState(null),[C,g]=o.useState(null),y=f.length,v=o.useRef(null);o.useEffect(()=>{try{const e=localStorage.getItem(S(r.slug??r.id));if(e){const s=JSON.parse(e);typeof s.currentIndex=="number"&&h(s.currentIndex),s.answers&&z(s.answers),typeof s.timeElapsed=="number"&&q(s.timeElapsed)}}catch(e){console.error("Error parsing stored quiz state",e)}},[r.slug,r.id]),o.useEffect(()=>{v.current=window.setInterval(()=>{q(s=>s+1)},1e3);const e=()=>{b()};return window.addEventListener("beforeunload",e),()=>{v.current&&window.clearInterval(v.current),window.removeEventListener("beforeunload",e),b()}},[]),o.useEffect(()=>{b()},[m,n,d]);function b(){try{const e={currentIndex:n,answers:m,timeElapsed:d};localStorage.setItem(S(r.slug??r.id),JSON.stringify(e))}catch(e){console.error("Could not save quiz state",e)}}function $(){try{localStorage.removeItem(S(r.slug??r.id))}catch(e){console.error("Could not clear quiz state",e)}}function k(e,s,i){z(u=>{const p={...u},w=e.id;if(i){const x=p[w]??[],I=x.indexOf(s);I>=0?x.splice(I,1):x.push(s),p[w]=x}else p[w]=s;return p})}function A(){n<y-1&&h(e=>e+1)}function R(){n>0&&h(e=>e-1)}function T(e){const s=m[e.id];return e.is_mandatory?Array.isArray(s)?s.length>0:!!s:!0}async function M(){const e=f.filter(i=>i.is_mandatory&&!T(i));if(e.length){g(`Veuillez répondre à toutes les questions obligatoires (${e.length}).`),window.scrollTo({top:0,behavior:"smooth"});return}_(!0),g(null);const s={quiz_id:r.id,answers:Object.entries(m).map(([i,u])=>({question_id:Number(i),answer:u})),time_elapsed_seconds:d};try{const i=await fetch(`/api/quizzes/${r.id}/submit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!i.ok)throw new Error(`Server responded ${i.status}`);const u=await i.json();$(),L("Quiz envoyé avec succès. Merci !")}catch(i){console.error("Submission error",i),g("Une erreur est survenue lors de l’envoi. Réessayez plus tard.")}finally{_(!1)}}const a=f[n],j=m[a?.id??-1];return t.jsx(J,{title:`Quiz : ${r.title??"Quiz"}`,children:t.jsxs("div",{className:"mx-auto mt-6 max-w-3xl",children:[t.jsxs("div",{className:"mb-4 flex flex-col items-center justify-between sm:flex-row",children:[t.jsxs("div",{children:[t.jsx("h1",{className:"text-xl font-bold text-gray-900",children:r.title??"Quiz"}),t.jsxs("p",{className:"mt-1 text-sm text-gray-500",children:["Progression:"," ",t.jsxs("span",{className:"font-medium",children:["Question ",n+1," / ",y]})]})]}),t.jsxs("div",{className:"mt-3 flex w-full flex-row justify-between gap-4 text-sm text-gray-600 sm:flex-col",children:[t.jsx("div",{className:"mb-1 text-right",children:"Temps écoulé"}),t.jsx("div",{className:"rounded-md bg-gray-100 px-3 py-1 font-mono text-sm",children:V(d)})]})]}),t.jsx(P,{className:"mb-4",variant:"outline",children:U(a.question_type)}),C&&t.jsx("div",{className:"mb-4 rounded-md border border-red-200 bg-red-50 p-3 text-sm text-red-700",children:C}),Q&&t.jsx("div",{className:"mb-4 rounded-md border border-green-200 bg-green-50 p-3 text-sm text-green-700",children:Q}),t.jsxs("div",{className:"rounded-lg border bg-white p-6 shadow-sm",children:[t.jsx("div",{className:"flex items-start justify-between",children:t.jsxs("div",{className:"flex-1",children:[t.jsxs("div",{className:"text-sm text-gray-500",children:["Question ",n+1," •"," ",a.points," pts"]}),t.jsx("h2",{className:"mt-2 text-lg font-semibold text-gray-800",children:a.question_text}),t.jsx("div",{className:"mt-4 space-y-3",children:(a.answers??[]).map(e=>{const s=a.question_type==="multiple_choice",i=s?Array.isArray(j)&&j.includes(e.id):j===e.id;return t.jsxs("label",{className:"flex cursor-pointer items-center gap-3 rounded-md border p-3 transition hover:bg-gray-50",children:[t.jsx("input",{type:s?"checkbox":"radio",name:`q_${a.id}`,checked:i,onChange:()=>k(a,e.id,s),className:"h-4 w-4"}),t.jsx("div",{className:"text-sm text-gray-700",children:e.answer_text})]},e.id)})})]})}),t.jsxs("div",{className:"mt-6 flex items-center justify-between",children:[t.jsx("div",{children:t.jsx(N,{variant:"outline",onClick:R,disabled:n===0,children:"Précédent"})}),t.jsx("div",{className:"flex items-center gap-3",children:n<y-1?t.jsx(N,{onClick:A,disabled:!T(a),children:"Suivant"}):t.jsx(N,{onClick:M,className:"bg-green-600 text-white hover:bg-green-700",disabled:E,children:E?"Envoi...":"Envoyer"})})]})]}),t.jsx("div",{className:"mt-4 text-center text-xs text-gray-400",children:"Vos réponses sont automatiquement sauvegardées localement."}),t.jsx("div",{className:"mt-6 text-center",children:t.jsx(B,{href:"/student/quizzes",className:"text-sm text-gray-500 hover:underline",children:"Retour à la liste des quizzes"})})]})})}export{De as default};
